{% extends "_template.html" %}
{% block title %}Home{% endblock %}
{% block content %}
{% if is_logged_in %}
You are logged in <a href="{{okta_config.app_host}}/logout">Logout</a>
{% else %}
<link href="{{okta_config.org_host}}/assets/loginpage/css/okta-login-page.min.88c003cadf2616a8827c8a1531c3fea9.css" type="text/css" rel="stylesheet" />
<div class="content">
  <style type="text/css">
    .noscript-msg {
      background-color: #fff;
      border-color: #ddd #ddd #d8d8d8;
      box-shadow: 0 2px 0 rgba(175, 175, 175, 0.12);
      text-align: center;
      width: 398px;
      min-width: 300px;
      margin: 200px auto;
      border-radius: 3px;
      border-width: 1px;
      border-style: solid;
    }

    .noscript-content {
      padding: 42px;
    }

    .noscript-content h2 {
      padding-bottom: 20px;
    }

    .noscript-content h1 {
      padding-bottom: 25px;
    }

    .noscript-content a {
      background: transparent;
      box-shadow: none;
      display: table-cell;
      vertical-align: middle;
      width: 314px;
      height: 50px;
      line-height: 36px;
      color: #fff;
      background: linear-gradient(#007dc1, #0073b2), #007dc1;
      border: 1px solid;
      border-color: #004b75;
      border-bottom-color: #00456a;
      box-shadow: rgba(0, 0, 0, 0.15) 0 1px 0, rgba(255, 255, 255, 0.1) 0 1px 0 0 inset;
      -webkit-border-radius: 3px;
      border-radius: 3px;
    }

    .noscript-content a:hover {
      background: #007dc1;
      cursor: hand;
      text-decoration: none;
    }
  </style>
  <noscript>
    <div id="noscript-msg" class="noscript-msg">
      <div class="noscript-content">
        <h2>Javascript is required</h2>
        <h1>Javascript is disabled on your browser.&nbspPlease enable Javascript and refresh this page.</h1>
        <a href=".">Refresh</a>
      </div>
    </div>
  </noscript>
  <div id="signin-container">
    <div data-se="auth-container" id="okta-sign-in" class="auth-container main-container no-beacon">
      <div class="okta-sign-in-header auth-header"> <img src="https://elab.okta.com/bc/image/fileStoreRecord?id=fs06b4hxh5tUgEA721t7" class="auth-org-logo" alt="ELAB Co">
        <div data-type="beacon-container" class="beacon-container"></div>
      </div>
      <div class="auth-content">
        <div class="auth-content-inner">
          <div class="forgot-password">
            <form method="POST" action="/signin/forgot-password" data-se="o-form" id="form17" class="o-form forgot-password-email-enabled o-form-edit-mode">
              <div data-se="o-form-content" class="o-form-content o-form-theme clearfix">
                <h2 data-se="o-form-head" class="okta-form-title o-form-head">Reset Password</h2>
                <div class="o-form-error-container" data-se="o-form-error-container"></div>
                <div class="o-form-fieldset-container" data-se="o-form-fieldset-container">
                  <div data-se="o-form-fieldset" class="o-form-fieldset o-form-label-top">
                    <div data-se="o-form-input-container" class="o-form-input"><span data-se="o-form-input-username" class="o-form-input-name-username o-form-control okta-form-input-field input-fix"> <span class="input-tooltip icon form-help-16"
                          data-hasqtip="0"></span>
                        <span class="icon input-icon person-16-gray"></span>
                        <input type="text" placeholder="Email or Username" name="username" id="input26" value="" aria-label="Email or Username" autocomplete="off">
                      </span>
                    </div>
                    <!-- Modal content -->
                    <div class="okta-form-title o-form-head">

                      <p>Reset with MFA</p>
                      <div data-se="o-form-fieldset" class="o-form-fieldset o-form-label-top">
                        <select id="factorList">
                          <option value="" default>Select Password Reset Factor</option>
                          <option value="token:software:totp">Okta Verify Code</option>
                          <option value="push">Okta Verify Push</option>
                          <option value="GOOGLE">Google Authenticator</option>
                          <option value="sms">SMS</option>
                          <option value="call">Voice</option>
                        </select>
                      </div>
                      <br />
                      <div id="modalContent">
                        <div id="smsModalContent">
                          <div><input id="smsRequest" type="button" value="Send Code" onclick="requestCode()" /><input type="text" id="smsCode" /></div>
                          <div><input id="smsSubmit" type="button" value="Submit Code" onclick="submitCode(document.getElementById('smsCode').value)" /></div>
                        </div>
                        <div id="googleAuthModalContent">
                          <div><input type="text" id="googleAuthCode" /></div>
                          <div><input id="googleAuthSubmit" type="button" value="Submit Code" onclick="submitCode(document.getElementById('googleAuthCode').value)" /></div>
                        </div>
                        <div id="oktaVerifyModalContent">
                          <div><input type="text" id="oktaVerifyCode" /></div>
                          <div><input id="OktaVerifySubmit" type="button" value="Submit Code" onclick="submitCode(document.getElementById('oktaVerifyCode').value)" /></div>
                        </div>
                        <div id="oktaVerifyPushModalContent">
                          <div><input id="oktaVerifyPushSubmit" type="button" value="Send Push" onclick="submitCode('')" /></div>
                        </div>
                        <div id="voiceModalContent">
                          <div><input id="voiceRequest" type="button" value="Call for Code" onclick="requestCode()" /><input type="text" id="voiceCode" /></div>
                          <div><input id="voiceSubmit" type="button" value="Submit Code" onclick="submitCode(document.getElementById('voiceCode').value)" /></div>
                        </div>
                      </div>
                      <input type="hidden" id="oktaFactorType" name="oktaFactorType" />
                    </div>
                  </div><a data-se="email-button" class="button button-primary button-wide email-button link-button" href="#">Reset via Email</a>
                </div>
              </div>
            </form>
            </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script type="text/javascript" src="{{okta_config.org_host}}/api/v1/sessions/me"></script>
<script>
  //<![CDATA[
    $(document).ready(function() {
        console.log("Ready!!!");
        $.get({
            url: "{{okta_config.org_host}}/api/v1/sessions/me",
            xhrFields: { withCredentials: true },
            crossDomain: true,
            success: data => {
                console.log("data: %s", JSON.stringify(data));
                var redirectUrl = "{{okta_config.redirect_url|safe}}";
                console.log("redirect_url: %s", redirectUrl)
                if (data.id) {
                    location.href = redirectUrl;
                }
            }
        });

        $("#factorList").on("change", onChangeFactorList);

        $(".close").on("click", function(){
            console.log("modal close button clicked");
			$("#modalPopup").hide();
		});

		$("#forgot-password-button").on("click", function() {
		    console.log("forgot-password-button clicked");
		    // first get the username/email and look up the user in Okta
		    // Display factors available for the user to use
		    console.log("email: " + $("#email").val());

		    $("#modalPopup").show();
		});
    });

    function onChangeFactorList(event) {
		console.log("onChangeFactorList()");
		// console.log(event);

		$("#smsModalContent").hide();
		$("#googleAuthModalContent").hide();
		$("#oktaVerifyModalContent").hide();
		$("#oktaVerifyPushModalContent").hide();
		$("#voiceModalContent").hide();

		var seletedFactorVal = $("#factorList").val();

		$("#oktaFactorType").val(seletedFactorVal);

		if(seletedFactorVal == "GOOGLE") {
			displayMFAGoogleAuth();
		} else if(seletedFactorVal == "sms") {
			displayMFASMS();
		} else if(seletedFactorVal == "push") {
			displayMFAOktaVerifyPush();
		} else if(seletedFactorVal == "token:software:totp") {
			displayMFAOktaVerify();
		} else if(seletedFactorVal == "call") {
			displayMFAVoice();
		}
	}

    function displayMFAGoogleAuth() {
		console.log("displayMFAGoogleAuth()");
		$("#googleAuthModalContent").show();
	}

	function displayMFASMS() {
		console.log("displayMFASMS()");
		$("#smsModalContent").show();
	}

	function displayMFAVoice() {
		console.log("displayMFAVoice()");
		$("#voiceModalContent").show();
	}

	function displayMFAOktaVerifyPush() {
		console.log("displayMFAOktaVerifyPush()");
		$("#oktaVerifyPushModalContent").show();
	}

	function displayMFAOktaVerify() {
		console.log("displayMFAOktaVerify()");
		$("#oktaVerifyModalContent").show();
	}

	function requestCode() {
		console.log("requestCode()");
		oktaMFARequest = {
			"username": $("#username").val(),
			"factorType": $("#oktaFactorType").val()
		}
		$.ajax({
			url: "{{config.app_host}}/push_mfa_code",
			type: "POST",
			data: JSON.stringify(oktaMFARequest),
			contentType: "application/json",
			dataType: "json",
			success: function(responseData) {
				console.log(responseData);
			}
		});

	}

	function submitCode(code) {
		console.log("submitCode()");
		oktaMFARequest = {
			"username": $("#username").val(),
			"factorType": $("#oktaFactorType").val(),
			"code": code
		}
		$.ajax({
			url: "{{config.app_host}}/push_mfa_code",
			type: "POST",
			data: JSON.stringify(oktaMFARequest),
			contentType: "application/json",
			dataType: "json",
			success: function(responseData) {
				console.log(responseData);
				if(responseData.factorResult == "SUCCESS") {
					console.log("Factor passed!");

					$("#ott").val(responseData.ott);
					$("#changePassword").submit();

				} else if (responseData.factorResult == "WAITING") {
					//Poll until result comes back
					pollingUrl = responseData.pollingUrl;
					pollOktaVerifyPushMFA(pollingUrl, $("#username").val());
				} else {
					alert("Incorrect Factor Pass Code");
				}
			}
		});
	}

	function pollOktaVerifyPushMFA(pollingUrl, userName) {
		console.log("pollOktaVerifyPushMFA()");
		body = {
			"pollingUrl": pollingUrl,
			"userName": userName
		};

		$.ajax({
			url: "{{config.app_host}}/mfa_verification_poll",
			type: "POST",
			data: JSON.stringify(body),
			contentType: "application/json",
			dataType: "json",
			success: function(requestData) {
				console.log(requestData);
				if(requestData.factorResult == "WAITING") {
					setTimeout(pollOktaVerifyPushMFA(pollingUrl, userName), 3000);
				} else if (requestData.factorResult == "SUCCESS") {
					console.log("Factor passed!");
					console.log(requestData);
					$("#ott").val(requestData.ott);
					$("#changePassword").submit();
				} else {
					alert("Failed factor!");
				}
			}
		});
	}
    //]]>
</script>
<input type="checkbox" id="form-switch">
<form id="login-form" method="POST" action="/login">
  <input type="text" name="username" placeholder="Username" required>
  <input type="password" name="password" placeholder="Password" required>
  <button type="submit">Login</button>
  <label for="form-switch"><span>Forgot Password</span></label>
</form>
<div id="forgotpassword-form">
  <div></div>
  <input id="username" type="text" placeholder="User Name" required>
  <button type="button" id="forgot-password-button">Forgot Password</button>
  <label for="form-switch">Back to Login</label>
</div>
<form id="changePassword" method="POST" action="/show_change_password">
  <input type="hidden" name="ott" id="ott" />
</form>
<!-- The MFA Modal -->
<div id="modalPopup" class="modal">


  {% endif %}
  {% endblock %}
